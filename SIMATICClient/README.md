# SimaticClient
### Клиент для подключения к контроллеру SIMATIC (S7-300/400/1200/1500/WIN AC) и выполнения вычислений

*Используется библиотека классов* [Sharp7](https://snap7.sourceforge.net/sharp7.html)

|*Only the example*|
|-|

Клиент позволяет получать данные по определенным адресам из контроллера, производить вычисления и логировать работу в журнале Windows.

##### Конфигурационный файл в формате JSON содержит основные ветки:
 - PLC: Указывается информация для подключения к контроллеру в свойстве NetworkSettings. Для опроса нескольких контроллеров необходимо в массив добавить объекты (словари).
     Поля свойств NetworkSettings:

	| Имя свойства | Описание    | Пример | 
	|:----------:|:-------------:|:---------------:|
	| Address    | IP-адрес контроллера |        192.168.0.10        | 
	| Rack       | Номер корзины контроллера              |    0             |  
	| Slot     |   Слот модуля с коммуникационным портом            |      1           |
	| PollPeriod  | Период опроса контроллера, мс               |         1000        |

 - Tags: Указывается информация по опрашиваемым тегам контроллеров в свойстве PLC. При опросе нескольких контроллеров необходимо добавить в массив добавить отдельный массив с объектами-тегами.
     Поля объекта массива свойства PLC:

	| Имя свойства | Описание    | Пример | 
	|:----------:|:-------------:|:---------------:|
	| Name    | Имя тега для вычисления ссылки в ParamRule |        TagFlow        | 
	| ValAddr       | Адрес блока данных, откуда читается значение тега|    10             |  
	| ValOffset     |   Смещение в блоке данных для значения тега            |      36           |
	| ValType  | Тип данных значения (REAL, DINT, INT, BYTE)               |         REAL        |
	| QualityUse  | Флаг использования отдельного тега для качества. При плохом качестве вычисления не выполняются (1,0)|         1        |
	| QualityAddr  | Адрес блока данных, откуда читается значение тега качества              |         10        |
	| QualityOffset  | Смещение в блоке данных для значения тега качества               |         40        |
	| QualityType  | Тип данных значения качества(REAL, DINT, INT, BYTE)              |         BYTE        |
	| Function  | Функция вычисления (FixDataChanged,ValueChanged)              |         FixDataChanged        |
	| FunctionParNum  |   Номер аргумента для передачи в функцию вычисления             |         0        |
	| ParamRule  | Формула/Правило для вычисления               |         1 & ((2 & 3) | (3 & 4))        |
	| TagLink  | Имена тегов в соответствии с позицией в ParamRule  (1,2,3...)             |         Tag1, Tag2, Tag3, Tag4        |

Пример JSON-файла с конфигурацией расположен в папке .\Data

 ##### Вычисления:
 
 В проекте реализованы два вида вычислений:
 - По умолчанию. Теги опрашиваются и выдаются в исходном типе данных, либо формируются как булевые теги на основе логических операций.
  Возможные операторы:
  
	| Оператор | Описание    | 
	|:----------:|:-------------:|
	| bool:eq <число>   | Равно |
	| bool:gt <число>      | Больше               | 
	| bool:lt <число>    |   Меньше            | 
	| bool:ge <число> | Больше или равно               | 
	| bool:le <число>  | Меньше или равно               |  
	| bool:x <число> | Проверка бита               |
	| & | Логический "И"               |
	| \| | Логический "ИЛИ"                |

 - С фиксацией по триггеру изменения. Фиксирование значения тега при переходе в истинное значение при выполнении указанной логики,и вычисление разницы значений при переходе в ложное значение логики.
 В параметре ParamRule указывается логическая формула для срабатывания триггера для фиксирования начального значения текущего тега при истине(true) и конечного при ложном срабатывании, после чего выполняется вычисление разницы.
Пареметры указываются как числовые идентификаторы.
Пример: 1 & ((2 & 3) | (3 & 4))
В TagLink указываются имена тегов из конфигурационного файла, которые участвуют в логической формуле. Идентификаторы в ParamRule соответствуют порядковому номеру тегов в TagLink.

 ##### Запуск службы:
- Разместить файл конфигурации(ServiceCfg.json) и файлы компиляции в папке C:\Services
- Открыть командную строку и выполнить:
```cd C:\Windows\Microsoft.NET\Framework64\v4.<версия>```
```Installutil.exe C:\services\IntmaPIService.exe```
- Открыть службы Windows и запустить сервис SimaticClientService

 ##### Просмотр событий:
 События отражаются в ветке Журнал Windows->Система->SimaticClientService
 